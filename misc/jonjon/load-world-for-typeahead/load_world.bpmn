<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:spiffworkflow="http://spiffworkflow.org/bpmn/schema/1.0/core" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" id="Definitions_96f6665" targetNamespace="http://bpmn.io/schema/bpmn" exporter="Camunda Modeler" exporterVersion="3.0.0-dev">
  <bpmn:process id="load_world" name="Load World" isExecutable="true">
    <bpmn:startEvent id="StartEvent_1">
      <bpmn:outgoing>Flow_0tn4ed3</bpmn:outgoing>
    </bpmn:startEvent>
    <bpmn:sequenceFlow id="Flow_0tn4ed3" sourceRef="StartEvent_1" targetRef="Activity_0o51srq" />
    <bpmn:endEvent id="Event_0jxoz7s">
      <bpmn:incoming>Flow_0lz96a1</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:sequenceFlow id="Flow_0lz96a1" sourceRef="Activity_0o51srq" targetRef="Event_0jxoz7s" />
    <bpmn:scriptTask id="Activity_0o51srq" name="Parse cities response">
      <bpmn:extensionElements>
        <spiffworkflow:unitTests>
          <spiffworkflow:unitTest id="test_top3">
            <spiffworkflow:inputJson>{
"typeahead": {},
  "cities_result": [
    {
      "id": 52,
      "name": "Ashkāsham",
      "state_id": 3901,
      "state_code": "BDS",
      "state_name": "Badakhshan",
      "country_id": 1,
      "country_code": "AF",
      "country_name": "Afghanistan",
      "latitude": "36.68333000",
      "longitude": "71.53333000",
      "wikiDataId": "Q4805192"
    },
    {
      "id": 68,
      "name": "Fayzabad",
      "state_id": 3901,
      "state_code": "BDS",
      "state_name": "Badakhshan",
      "country_id": 1,
      "country_code": "AF",
      "country_name": "Afghanistan",
      "latitude": "37.11664000",
      "longitude": "70.58002000",
      "wikiDataId": "Q156558"
    },
    {
      "id": 78,
      "name": "Jurm",
      "state_id": 3901,
      "state_code": "BDS",
      "state_name": "Badakhshan",
      "country_id": 1,
      "country_code": "AF",
      "country_name": "Afghanistan",
      "latitude": "36.86477000",
      "longitude": "70.83421000",
      "wikiDataId": "Q10308323"
    }
  ]
}</spiffworkflow:inputJson>
            <spiffworkflow:expectedOutputJson>{
  "typeahead": {
    "cities": [
      {
        "search_term": "Ashkāsham",
        "result": {
          "name": "Ashkāsham",
          "country": "Afghanistan",
          "state": "Badakhshan"
        }
      },
      {
        "search_term": "Fayzabad",
        "result": {
          "name": "Fayzabad",
          "country": "Afghanistan",
          "state": "Badakhshan"
        }
      },
      {
        "search_term": "Jurm",
        "result": {
          "name": "Jurm",
          "country": "Afghanistan",
          "state": "Badakhshan"
        }
      }
    ],
    "countries": [
      {
        "result": {
          "name": "Afghanistan"
        },
        "search_term": "Afghanistan"
      }
    ]
  }
}</spiffworkflow:expectedOutputJson>
          </spiffworkflow:unitTest>
        </spiffworkflow:unitTests>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_0tn4ed3</bpmn:incoming>
      <bpmn:outgoing>Flow_0lz96a1</bpmn:outgoing>
      <bpmn:script>def parse_cities_result():
    cities = []
    countries = []
    states_by_country = {}

    for result in cities_result:
        name = result["name"]
        state = result["state_name"]
        country = result["country_name"]
        cities.append({"search_term": name, "result": {"name": name, "state": state, "country": country}})
        if country not in states_by_country:
            states_by_country[country] = set()
        states_by_country[country].add(state)

    for country in states_by_country.keys():
        countries.append({"search_term": country, "result":{"name": country}})
    
    return { "cities": cities, "countries": countries }

typeahead = parse_cities_result()

del(cities_result)</bpmn:script>
    </bpmn:scriptTask>
  </bpmn:process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="load_world">
      <bpmndi:BPMNShape id="_BPMNShape_StartEvent_2" bpmnElement="StartEvent_1">
        <dc:Bounds x="179" y="159" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_0jxoz7s_di" bpmnElement="Event_0jxoz7s">
        <dc:Bounds x="432" y="159" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_1fwfxsn_di" bpmnElement="Activity_0o51srq">
        <dc:Bounds x="270" y="138" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Flow_0tn4ed3_di" bpmnElement="Flow_0tn4ed3">
        <di:waypoint x="215" y="177" />
        <di:waypoint x="243" y="177" />
        <di:waypoint x="243" y="178" />
        <di:waypoint x="270" y="178" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0lz96a1_di" bpmnElement="Flow_0lz96a1">
        <di:waypoint x="370" y="178" />
        <di:waypoint x="401" y="178" />
        <di:waypoint x="401" y="177" />
        <di:waypoint x="432" y="177" />
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>
